<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map Test - Debug</title>
  <link rel="stylesheet" href="/styles/dashboard.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
</head>
<body>
  <main>
    <nav class="nav-tabs">
      <a href="/">Overview</a>
      <a href="/stats">Stats</a>
      <a href="/maps">Maps</a>
      <a href="/api">API</a>
      <a class="active" href="/map-test">Map Test</a>
    </nav>
    
    <header class="page-header">
      <div>
        <span class="badge badge-neutral">Map Debug</span>
        <h1>Map Loading Test</h1>
        <p>Debug map loading and D3.js functionality</p>
      </div>
    </header>

    <!-- Library Status -->
    <div class="card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Libraries</p>
          <h2>Library Status</h2>
        </div>
      </header>
      <div id="library-status">
        <p class="text-muted">Checking library availability...</p>
      </div>
    </div>

    <!-- Data Loading Test -->
    <div class="card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Data</p>
          <h2>Data Loading Test</h2>
        </div>
        <button onclick="testDataLoading()" class="btn btn-primary">Test Data Loading</button>
      </header>
      <div id="data-status">
        <p class="text-muted">Click "Test Data Loading" to check data availability</p>
      </div>
    </div>

    <!-- Simple Map Test -->
    <div class="card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Map</p>
          <h2>Simple Map Test</h2>
        </div>
        <button onclick="createSimpleMap()" class="btn btn-primary">Create Test Map</button>
      </header>
      <div class="map-container">
        <div id="test-map" style="min-height: 300px; border: 1px dashed var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
          Click "Create Test Map" to test D3.js rendering
        </div>
      </div>
    </div>
  </main>

  <script src="/js/common.js"></script>
  <script>
    // Check library availability
    function checkLibraries() {
      const status = document.getElementById('library-status');
      const libraries = [
        { name: 'D3.js', available: typeof d3 !== 'undefined', version: typeof d3 !== 'undefined' ? d3.version : 'N/A' },
        { name: 'TopoJSON', available: typeof topojson !== 'undefined', version: 'N/A' },
        { name: 'Common Utils', available: typeof window.DashboardUtils !== 'undefined', version: 'N/A' }
      ];

      let statusHTML = '<div class="table-container"><table><thead><tr><th>Library</th><th>Status</th><th>Version</th></tr></thead><tbody>';
      
      libraries.forEach(lib => {
        const statusText = lib.available ? '✅ Available' : '❌ Not Available';
        const statusClass = lib.available ? 'badge-success' : 'badge-warning';
        statusHTML += `
          <tr>
            <td><strong>${lib.name}</strong></td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td>${lib.version}</td>
          </tr>
        `;
      });
      
      statusHTML += '</tbody></table></div>';
      status.innerHTML = statusHTML;
    }

    // Test data loading
    async function testDataLoading() {
      const status = document.getElementById('data-status');
      status.innerHTML = '<p class="text-muted">Testing data loading...</p>';
      
      const tests = [
        { name: 'State Stats', url: '/state-stats.json' },
        { name: 'Status JSON', url: '/status.json' },
        { name: 'US States TopoJSON', url: '/data/us-states.topojson' }
      ];
      
      let resultsHTML = '<div class="table-container"><table><thead><tr><th>Endpoint</th><th>Status</th><th>Response</th></tr></thead><tbody>';
      
      for (const test of tests) {
        try {
          const response = await fetch(test.url);
          const statusText = response.ok ? '✅ OK' : `❌ Error ${response.status}`;
          const contentType = response.headers.get('content-type') || 'Unknown';
          
          if (response.ok) {
            const data = await response.json();
            const dataInfo = test.name === 'US States TopoJSON' ? 
              `Objects: ${Object.keys(data.objects || {}).length}` :
              `Keys: ${Object.keys(data).length}`;
            resultsHTML += `<tr><td>${test.name}</td><td>${statusText}</td><td>${contentType} - ${dataInfo}</td></tr>`;
          } else {
            resultsHTML += `<tr><td>${test.name}</td><td>${statusText}</td><td>${contentType}</td></tr>`;
          }
        } catch (error) {
          resultsHTML += `<tr><td>${test.name}</td><td>❌ Failed</td><td>${error.message}</td></tr>`;
        }
      }
      
      resultsHTML += '</tbody></table></div>';
      status.innerHTML = resultsHTML;
    }

    // Create a simple test map
    function createSimpleMap() {
      const container = document.getElementById('test-map');
      
      if (typeof d3 === 'undefined') {
        container.innerHTML = '<p class="text-muted">❌ D3.js not available</p>';
        return;
      }
      
      try {
        // Clear container
        container.innerHTML = '';
        
        // Create SVG
        const svg = d3.select(container)
          .append('svg')
          .attr('width', 400)
          .attr('height', 300)
          .style('border', '1px solid var(--border)');
        
        // Add some test shapes
        svg.append('circle')
          .attr('cx', 100)
          .attr('cy', 100)
          .attr('r', 30)
          .attr('fill', 'var(--blue-500)');
        
        svg.append('rect')
          .attr('x', 200)
          .attr('y', 70)
          .attr('width', 60)
          .attr('height', 60)
          .attr('fill', 'var(--red-500)');
        
        svg.append('text')
          .attr('x', 200)
          .attr('y', 200)
          .attr('text-anchor', 'middle')
          .attr('fill', 'var(--text-primary)')
          .text('D3.js is working!');
        
        container.innerHTML = '';
        container.appendChild(svg.node());
        
      } catch (error) {
        container.innerHTML = `<p class="text-muted">❌ Error creating map: ${error.message}</p>`;
      }
    }

    // Initialize on page load
    checkLibraries();
  </script>
</body>
</html>
